---
name: Check for new usages of deprecated functionality

permissions:
  contents: read

on:
  pull_request:
    types: ['opened', 'synchronize']
    paths:
      - '.github/workflows/gradually-deprecated.yaml'
      - './scripts/run-gradually-deprecated.sh'
      - '**.go'

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0
      - uses: actions/setup-go@40f1582b2485089dde7abd97c1529aa768e1baff # v5.6.0
        with:
          go-version-file: ./.go-version
      - run: bash ./scripts/run-gradually-deprecated.sh
      - name: Guidance on failure
        if: failure()
        run: |
          echo "::error::New usage of deprecated functionality detected."
          echo ""
          echo "Your changes introduce new usages of deprecated functions or patterns."
          echo "Please use the recommended replacement instead. Check the output above"
          echo "for details on which deprecated items were referenced."
  save-artifacts-on-fail:
    needs: test
    if: ${{ failure() }}
    uses: ./.github/workflows/save-artifacts.yaml
  comment-on-fail:
    needs: test
    if: ${{ failure() }}
    uses: ./.github/workflows/comment-failure.yaml
